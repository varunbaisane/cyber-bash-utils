#!/usr/bin/env bash

set -euo pipefail

CORE_BIN="$(command -v cyber-core)"
CORE_DIR="$(cd "$(dirname "$(readlink -f "$CORE_BIN")")/../core" && pwd)"
source "$CORE_DIR/common.sh"

require_cmd curl
require_cmd xargs

TIMEOUT=3
PARALLEL_JOBS=20

probe_url() {
    local url="$1"

    local code
    code="$(curl -s -o /dev/null -w "%{http_code}" --max-time "$TIMEOUT" "$url" || true)"

    if [ "$code" != "000" ]; then
        echo "$url [$code]"
    fi
}

export -f probe_url
export TIMEOUT

cat \
    | grep -v '^[[:space:]]*$' \
    | xargs -P "$PARALLEL_JOBS" -I{} bash -c '
        host="{}"
        probe_url "http://$host"
        probe_url "https://$host"
    '
