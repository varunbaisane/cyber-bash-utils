#!/usr/bin/env bash

set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

CORE_BIN="$(command -v cyber-core)"
CORE_DIR="$(cd "$(dirname "$(readlink -f "$CORE_BIN")")/../core" && pwd)"
source "$CORE_DIR/common.sh"

parse_args "$@"

TARGET="$TARGET"

require_cmd ping
require_cmd xargs
require_cmd seq

PARALLEL_JOBS=20
PING_TIMEOUT=1

if is_ipv4 "$TARGET"; then
    if ping -c 1 -W "$PING_TIMEOUT" "$TARGET" >/dev/null 2>&1; then
        echo "$TARGET"
    fi
    exit 0
fi

log_info "Scanning subnet: $TARGET"
log_info "Parallel jobs: $PARALLEL_JOBS"

NETWORK="${TARGET%/*}"
IFS=. read -r o1 o2 o3 _ <<< "$NETWORK"

seq 1 254 | xargs -P "$PARALLEL_JOBS" -I{} bash -c '
ip="'"$o1.$o2.$o3"'.{}"
ping -c 1 -W '"$PING_TIMEOUT"' "$ip" >/dev/null 2>&1 && echo "$ip"
'
